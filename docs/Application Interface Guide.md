# Application Interface Guide (API v1)

Welcome to the Product Quality Alert System API documentation. This API provides access to automating the creation of JIRA tickets from product quality alerts for rapid incident response.

## Introduction

This API consumes event data in **JSON** format, delivered via Google Cloud Pub/Sub. It is designed to bridge product quality analytics with JIRA for rapid incident response.

> **Pub/Sub Topic for Alerts**
> ```
> product-quality-alerts (in GCP Project: sada-joseph-shorter-sada)
> ```

---

## Authentication & Cloud Security

Security is our top priority. This event-driven API leverages Google Cloud's Identity and Access Management (IAM) for secure message publishing and function execution, and Google Secret Manager for sensitive credentials.

### 1. IAM Permissions (Pub/Sub Publisher Access)
To publish messages to the `product-quality-alerts` topic, the calling service account or user must be granted the `roles/pubsub.publisher` role for the topic within the `sada-joseph-shorter-sada` Google Cloud Project.

```yaml
# Example IAM Policy for a publisher service account
- members:
  - serviceAccount: your-publishing-service-account@your-gcp-project.iam.gserviceaccount.com
  role: roles/pubsub.publisher
```

### 2. Cloud Function Service Account & Secret Management

The `product-quality-jira-processor` Cloud Function executes under a dedicated service account (`sada-joseph-shorter-sada@appspot.gserviceaccount.com`). This service account is configured with:

*   `roles/pubsub.subscriber`: To pull messages from the `product-quality-alerts` topic.
*   `roles/run.invoker`: To allow Pub/Sub to trigger the Cloud Function (for push subscriptions).
*   Access to Google Secret Manager: Specifically to retrieve the JIRA API Key from `projects/900228280944/secrets/JIRA_API_KEY`. This ensures sensitive credentials are never hardcoded or exposed in the environment.

### 3. Security Best Practices

*   **Least Privilege:** All IAM roles are assigned following the principle of least privilege.
*   **Credential Management:** JIRA API keys are securely stored in Google Secret Manager and accessed at runtime.
*   **Secure Environment:** The Cloud Function runs within Google's managed, secure infrastructure.

-----

## Endpoints

The primary interface for this API is publishing a structured JSON message to a Google Cloud Pub/Sub topic, which then triggers the `product-quality-jira-processor` Cloud Function.

### Publish Product Quality Alert

This operation triggers the creation of a JIRA ticket based on a detected product quality issue. The `product-quality-jira-processor` Cloud Function acts as a listener for messages published to this topic.

**Action**
`PUBLISH` a message to the `product-quality-alerts` Pub/Sub Topic.

**Pub/Sub Topic ID:** `product-quality-alerts`
**GCP Project ID:** `sada-joseph-shorter-sada`

**Message Body (JSON)**
The Pub/Sub message data payload must be a Base64-encoded JSON object with the following attributes. The `severity`, `product_name`, `product_id`, and `revenue_at_risk` attributes are mandatory for successful JIRA ticket creation.

| Attribute | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| `severity` | string | Yes | The severity level of the alert (e.g., `CRITICAL`, `HIGH`, `MEDIUM`, `LOW`). This maps directly to JIRA priority. |
| `product_name` | string | Yes | The name of the product impacted by the quality issue. |
| `product_id` | string | Yes | A unique identifier for the product (e.g., SKU, internal ID). |
| `revenue_at_risk` | number | Yes | Estimated revenue (USD) at risk due to the quality issue. |
| `category` | string | No | The product's category (e.g., "Toys & Games"). |
| `brand` | string | No | The product's brand. |
| `recommended_actions` | array of strings | No | A list of recommended actions to address the issue. If not provided, a default set of actions is added to the JIRA description. |
| `avg_sentiment` | number | No | Average customer sentiment score (e.g., `0.35`). |
| `negative_ratio` | number | No | Ratio of negative customer reviews (e.g., `0.25`). |
| `sentiment_change` | number | No | Percentage change in sentiment over the analysis period (e.g., `-0.10` for a 10% decrease). |
| `review_count` | integer | No | Total number of customer reviews considered in the analysis. |
| `recent_revenue` | number | No | Recent revenue (USD) generated by the product. |
| `revenue_change_pct` | number | No | Percentage change in product revenue (e.g., `-0.05` for a 5% decrease). |
| `alert_timestamp` | string (ISO 8601) | No | Timestamp when the alert was generated (e.g., `2023-10-27T10:00:00Z`). |
| `analysis_period_days` | integer | No | The number of days the analysis covers (default: `7`). |
| `price` | string | No | The price point of the product. |

**Example Request (gcloud CLI)**

```bash
gcloud pubsub topics publish product-quality-alerts \
  --project=sada-joseph-shorter-sada \
  --message='{
    "severity": "HIGH",
    "product_name": "Fisher-Price Code-a-Pillar",
    "product_id": "FP001",
    "revenue_at_risk": 13082.00,
    "recommended_actions": [
      "Investigate sensor malfunction",
      "Update firmware"
    ],
    "avg_sentiment": 0.35,
    "negative_ratio": 0.25,
    "sentiment_change": -0.10,
    "review_count": 150,
    "recent_revenue": 52000.00,
    "revenue_change_pct": -0.05,
    "alert_timestamp": "2023-10-27T10:00:00Z",
    "category": "Educational Toys"
  }'
```

**Response**
Cloud Functions triggered by Pub/Sub do not return direct HTTP responses to the publisher. Success or failure of the processing is indicated by the Pub/Sub message being acknowledged or retried according to the configured retry policy. All processing outcomes and errors are recorded in Google Cloud Logging.

-----

## Errors

The Cloud Function implements robust error handling and logging, with automatic retry mechanisms for transient issues. All errors and processing details are logged to Google Cloud Logging.

### Error Handling Philosophy

*   **Transient Errors:** For temporary issues (e.g., JIRA service unavailability, network timeouts), the Cloud Function re-raises the exception, causing Pub/Sub to retry the message with exponential backoff.
*   **Permanent Errors:** For irrecoverable errors (e.g., malformed JSON payload), the Cloud Function logs the error but acknowledges the message to prevent infinite retry loops, ensuring bad messages don't block the queue.

### Logged Error Types & Behavior

| Error Type | Description | Cloud Function Behavior | Pub/Sub Message Action |
| :--- | :--- | :--- | :--- |
| `json.JSONDecodeError` | The Pub/Sub message data payload is not valid JSON. | Logs error, acknowledges message. | Acknowledge (no retry) |
| JIRA Service Unavailable | JIRA API returns 404/502/503 status, or `Site temporarily unavailable` error message. | Logs error, re-raises exception. | Retry with exponential backoff |
| Connection/Network Error | Issues connecting to JIRA API (e.g., `timeout`, `connection` errors). | Logs error, re-raises exception. | Retry with exponential backoff |
| Missing Environment Vars | Required JIRA configuration (e.g., `JIRA_PROJECT_ID`) is missing. | Logs critical error, acknowledges message. | Acknowledge (no retry) |
| Other `Exception` | Any other unexpected error during processing. | Logs error, attempts to classify as transient/permanent. | Acknowledge or Retry based on keywords |

### Example Log Output (Google Cloud Logging)

**Successful Ticket Creation**
```
INFO      Received alert from Pub/Sub (Message ID: 123456789012345)
INFO      Processing: Fisher-Price Code-a-Pillar (ID: FP001, Severity: HIGH, Revenue at Risk: $13,082.00)
INFO      ‚úÖ JIRA ticket created: AITD-123 for Fisher-Price Code-a-Pillar (severity: HIGH)
INFO      ‚úÖ SUCCESS: Created AITD-123 for Fisher-Price Code-a-Pillar
INFO         URL: https://sadaadvservices.atlassian.net/browse/AITD-123
INFO         Product ID: FP001, Revenue at Risk: $13,082.00
```

**Transient Error (JIRA Unavailable - Triggers Retry)**
```
INFO      Received alert from Pub/Sub (Message ID: 123456789012346)
INFO      Processing: K'NEX Plants vs Zombies (ID: KNX002, Severity: MEDIUM, Revenue at Risk: $9,070.00)
ERROR     Error creating JIRA ticket: Exception('JIRA service is down - credentials cannot be tested')
ERROR     ‚ùå FAILED to create JIRA ticket for K'NEX Plants vs Zombies (ID: KNX002)
ERROR        Error: JIRA service is down - credentials cannot be tested
ERROR        Severity: MEDIUM, Revenue at Risk: $9,070.00
WARNING   ‚ö†Ô∏è  JIRA service appears to be unavailable - message will be retried
WARNING   üîÑ Transient error detected - message will be retried by Pub/Sub
```

**Permanent Error (Malformed JSON - No Retry)**
```
ERROR     ‚ùå Failed to parse Pub/Sub message JSON: Expecting property name enclosed in double quotes: line 1 column 2 (char 1)
ERROR        Raw message: {severity: "HIGH", product_name: "Malformed Data"}
ERROR     ‚ùå Error processing Pub/Sub message: Expecting property name enclosed in double quotes: line 1 column 2 (char 1)
ERROR     ‚ö†Ô∏è  Permanent error - message will be acknowledged to avoid retry loop
```

-----

## Webhooks

The `product-quality-jira-processor` Cloud Function effectively *acts as a webhook listener* for the Google Cloud Pub/Sub topic `product-quality-alerts`. Instead of exposing a traditional HTTP webhook endpoint, this event-driven architecture leverages Pub/Sub for reliable, scalable, and secure event delivery.

When a message is published to the `product-quality-alerts` topic, the Cloud Function is automatically invoked, allowing real-time processing of product quality issues. This means you do not need to run an external listener or expose your own service to the internet; Google Cloud handles the event triggering and Function execution.