# Application Interface Guide (Internal API v1)

Welcome to the Product Quality Alert Processing API documentation. This API provides access to automating the creation of JIRA tickets for product quality alerts, bridging analytics with issue tracking.

## Introduction

This API follows an **event-driven architecture** and processes data in **JSON** format via Google Cloud Pub/Sub. It is designed to bridge BigQuery analytics and various product data sources with JIRA issue tracking using Google Cloud infrastructure.

> **Pub/Sub Topic Name**
> ```
> projects/sada-joseph-shorter-sada/topics/product-quality-alerts
> ```

---

## Authentication & GCP Security

Security is our top priority. This system utilizes Google Cloud Platform's native security features, including IAM Service Accounts and Secret Manager, for secure and authorized operations.

### 1. Service Accounts (Internal Access)
Access to GCP resources (Pub/Sub, Secret Manager) and invocation of the Cloud Function is managed via IAM Service Accounts.

*   **Cloud Function Invoker/Subscriber:** `sada-joseph-shorter-sada@appspot.gserviceaccount.com`
    *   `roles/pubsub.subscriber`: Can receive messages from Pub/Sub.
    *   `roles/run.invoker`: Can invoke the Cloud Run service (underlying Cloud Function).
    *   This service account also has permissions to access `Secret Manager` for JIRA API keys.

*   **Pub/Sub Push Invoker:** `service-900228280944@gcp-sa-pubsub.iam.gserviceaccount.com`
    *   `roles/run.invoker`: Pub/Sub can push messages to the Cloud Function.

### 2. JIRA API Key (External Integration)

**Never hardcode credentials.** The JIRA API Key, required for creating tickets, is securely stored in Google Secret Manager.

*   **Secret ID:** `projects/900228280944/secrets/JIRA_API_KEY/versions/latest`
*   The Cloud Function accesses this key at runtime using its assigned service account.

### 3. Security Best Practices

Please adhere to the following guidelines for robust security:

*   **Least Privilege:** Ensure service accounts have only the minimum necessary permissions.
*   **Secret Rotation:** Regularly rotate API keys stored in Secret Manager.
*   **Logging:** Monitor Cloud Audit Logs for unauthorized access attempts or unusual activity.

-----

## Message Interface

The system's primary interface is through Google Cloud Pub/Sub messages. Publishing a message to the `product-quality-alerts` topic triggers the `product-quality-jira-processor` Cloud Function.

### Publish Product Quality Alert

Publishes a product quality alert, containing detailed analytics, to the `product-quality-alerts` topic. This action immediately triggers the Cloud Function to create a corresponding JIRA ticket.

**Request**
`PUBLISH to topic: product-quality-alerts`

**Message Payload (JSON Body Attributes)**
The message data is a base64-encoded JSON string representing the product quality alert.

| Attribute | Type | Description |
| :--- | :--- | :--- |
| `product_name` | string | The name of the product (e.g., "Fisher-Price Code-a-Pillar"). |
| `product_id` | string | Unique identifier for the product. |
| `severity` | string | Severity of the alert (`CRITICAL`, `HIGH`, `MEDIUM`, `LOW`). |
| `category` | string | Product category (e.g., "Toys"). |
| `brand` | string | Product brand. |
| `alert_timestamp` | string | Timestamp when the alert was generated (ISO 8601 format). |
| `analysis_period_days` | integer | Number of days covered by the analysis (default: 7). |
| `avg_sentiment` | float | Average sentiment score for the product (e.g., 0.75). |
| `negative_ratio` | float | Ratio of negative reviews. |
| `sentiment_change` | float | Percentage change in sentiment over the period. |
| `review_count` | integer | Total number of reviews analyzed. |
| `recent_revenue` | float | Recent revenue generated by the product. |
| `revenue_change_pct` | float | Percentage change in revenue. |
| `revenue_at_risk` | float | Estimated revenue at risk due to quality issues. |
| `price` | string | Price point of the product (e.g., "$13.99"). |
| `recommended_actions` | array of strings | List of suggested actions to address the alert. |

**Example Message (Base64-decoded JSON)**

```json
{
  "severity": "HIGH",
  "product_name": "Fisher-Price Code-a-Pillar",
  "product_id": "FP-001-CATERPILLAR",
  "category": "Educational Toys",
  "brand": "Fisher-Price",
  "alert_timestamp": "2025-11-13T10:30:00Z",
  "analysis_period_days": 7,
  "avg_sentiment": 0.45,
  "negative_ratio": 0.35,
  "sentiment_change": -0.15,
  "review_count": 1200,
  "recent_revenue": 50000.00,
  "revenue_change_pct": -0.10,
  "revenue_at_risk": 13082.00,
  "price": "$29.99",
  "recommended_actions": [
    "Investigate reported software glitches",
    "Review manufacturing batch B-452"
  ]
}
```

**System Behavior Upon Message Receipt**
Upon receiving a message, the `product-quality-jira-processor` Cloud Function performs the following actions:

1.  **Parses Message:** Decodes and validates the JSON payload.
2.  **Generates JIRA Ticket:** Connects to JIRA via its API and creates a new ticket (e.g., "AITD-XXX") with a detailed description, setting priority based on `severity`.
3.  **Logs Activity:** Records successful ticket creation or any errors in Cloud Logging.

-----

## Error Handling & Retry Mechanism

This system employs robust error handling and leverages Pub/Sub's built-in retry mechanisms to ensure message delivery and processing.

### Error Types & Handling

| Category | Description | Cloud Function Action | Pub/Sub Retry Policy |
| :--- | :--- | :--- | :--- |
| **Transient Errors** | Temporary issues like network glitches, JIRA API unavailability (e.g., 404, 502, 503, connection timeouts), or external service outages. | Logs a `WARNING` and re-raises the exception. | Pub/Sub automatically retries the message with exponential backoff. |
| **Permanent Errors** | Non-recoverable issues such as malformed JSON payloads, missing essential environment variables, or invalid JIRA configuration. | Logs an `ERROR` but *acknowledges* the message to prevent infinite retries. | No retry; message is discarded from the subscription queue. |
| **Authentication Failures** | Incorrect JIRA API key or invalid user email. | Logs an `ERROR`. Classified as a permanent error if the API key is retrieved but invalid, or transient if JIRA is down. | Depends on root cause; treated as permanent if credentials are definitively bad. |

### Pub/Sub Automatic Retries

For transient errors, Pub/Sub is configured with automatic retry logic:

*   **Initial Retry:** 10 seconds after the first failure.
*   **Exponential Backoff:** Retries will increase in delay, up to a maximum of 600 seconds (10 minutes) between attempts.
*   **Message Retention:** Messages are retained for up to 7 days, providing ample time for external systems (like JIRA) to recover.
*   **Dead-Letter Topic:** (Not explicitly configured in provided code, but good practice) For messages that repeatedly fail, a dead-letter topic can capture them for manual inspection.

**Error Logging Format**
Errors are logged to Google Cloud Logging. For example:

```
‚ùå FAILED to create JIRA ticket for Fisher-Price Code-a-Pillar (ID: FP-001-CATERPILLAR)
   Error: JIRA service unavailable: Site temporarily unavailable
   Severity: HIGH, Revenue at Risk: $13,082.00
‚ö†Ô∏è  JIRA service appears to be unavailable - message will be retried
```

-----

## Event-Driven System & Monitoring

The system is inherently event-driven, with Pub/Sub acting as the central nervous system for triggering actions. Monitoring is crucial to ensure the smooth operation of this automated workflow.

### Event Triggers

The core event is a message being published to the `product-quality-alerts` Pub/Sub topic. This directly invokes the `process_quality_alert` Cloud Function.

### Monitoring Tools & Methods

Several methods are available for monitoring the health and performance of the Product Quality Alert system:

1.  **Cloud Function Logs:**
    *   View real-time logs for executions, successes, and errors.
    *   Command:
        ```bash
        gcloud functions logs read product-quality-jira-processor \
          --region=us-central1 \
          --gen2 \
          --limit=50 \
          --project=sada-joseph-shorter-sada
        ```

2.  **Pub/Sub Subscription Metrics:**
    *   Monitor the number of undelivered messages to identify backlogs or persistent errors.
    *   Command to check messages in queue:
        ```bash
        gcloud pubsub subscriptions describe \
          eventarc-us-central1-product-quality-jira-processor-612217-sub-916 \
          --project=sada-joseph-shorter-sada
        ```
    *   Command to view subscription metrics:
        ```bash
        gcloud monitoring time-series list \
          --filter='metric.type="pubsub.googleapis.com/subscription/num_undelivered_messages"' \
          --project=sada-joseph-shorter-sada
        ```

3.  **JIRA Status Check Script:**
    *   A dedicated script is available to verify JIRA connectivity and API credential validity.
    *   Path: `/cloud_function_jira_processor/test_jira_status.py`
    *   Running this script confirms if external JIRA services are operational.

4.  **Cloud Monitoring & Alerting:**
    *   Configure custom alerts in Google Cloud Monitoring for specific error rates in Cloud Function logs, or for persistent queues in Pub/Sub subscriptions.

```json
// Example Cloud Function Log Entry (Success)
{
  "severity": "INFO",
  "message": "‚úÖ SUCCESS: Created AITD-XYZ for K'NEX Plants vs Zombies",
  "product_name": "K'NEX Plants vs Zombies",
  "ticket_key": "AITD-XYZ",
  "ticket_url": "https://sadaadvservices.atlassian.net/browse/AITD-XYZ"
}
```

```json
// Example Cloud Function Log Entry (Error with retry)
{
  "severity": "ERROR",
  "message": "‚ùå FAILED to create JIRA ticket for Fisher-Price Code-a-Pillar (ID: FP-001-CATERPILLAR)",
  "error_details": "JIRA service unavailable: Site temporarily unavailable",
  "product_id": "FP-001-CATERPILLAR",
  "revenue_at_risk": 13082.00,
  "retry_status": "üîÑ Transient error detected - message will be retried by Pub/Sub"
}
